<!DOCTYPE html>
<html>
  <head>
    <title>Play Game <%= game_id %> - Beauty Contest</title>
    <style>
    </style>
  </head>
  <body>
    <h1>GAME <%= game_id %></h1>
    <h3><%= nickname %></h3>
    <div id="content">
      <p>Please wait until the host starts the game</p>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      var round = 0;
      socket.on('round start', function(that_game_id) {
          if (that_game_id == <%= game_id %>){
            round ++;
            document.getElementById("content").innerHTML = `<h3>Round ${round}</h3>`
            const newDiv = document.createElement("div");
            newDiv.id = "form"
            newDiv.innerHTML +=  `
            <p>Pick a number between 1 to 100.</p>
            <input type="number" id="number">
            <button type="submit" onclick="submitNumber()">Submit</button>
            `
            document.getElementById("content").appendChild(newDiv)
          }
      })
      socket.on('round end', function(that_game_id, user_data) {
          if (that_game_id == <%= game_id %>){
            const user_scores = Object.values(user_data);
            const average = list => list.reduce((prev, curr) => prev + curr) / list.length;
            const winning_score = average(user_scores) * 0.8;
            const winner_score = user_scores.reduce((prev, curr) => Math.abs(curr - winning_score) < Math.abs(prev - winning_score) ? curr : prev);
            const winner = Object.keys(user_data).filter(function(key) {return user_data[key] === winner_score})[0];
            document.getElementById("content").innerHTML = `<h3>Round ${round} results</h3>`
            const newDiv = document.createElement("div");
            for (let user in user_data) {
              const p = document.createElement("p");
              if (user == winner){
                p.innerText = "WINNER: " + user + ":" + user_data[user]
                p.style.fontWeight = "bold";
              } else {
                p.innerText = user + ":" + user_data[user]
              }
              newDiv.append(p); 
            }
            document.getElementById("content").appendChild(newDiv)
          }
      })
      function submitNumber(){
        let number = document.getElementById("number").value;
        if (number > 100 || number < 0){
          document.getElementById("number").value = "";
        } else {
          socket.emit('submit number', "<%= nickname %>", <%= game_id %>, number);
          document.getElementById("form").innerHTML = "Number submitted!"
        }
      }
  </script>
  </body>
</html>